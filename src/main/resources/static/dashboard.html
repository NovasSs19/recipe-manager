<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Recipes - Recipe Manager</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin: 0; padding: 0; min-height: 100vh; color: #333; }
        header { background: rgba(255, 255, 255, 0.95); padding: 15px 40px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        h1 { margin: 0; color: #764ba2; font-size: 24px; }
        .logout-btn { background: #e74c3c; color: white; border: none; padding: 8px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .logout-btn:hover { background: #c0392b; transform: scale(1.05); }
        .container { max-width: 1000px; margin: 40px auto; padding: 0 20px; }
        .add-box { background: white; padding: 25px; border-radius: 15px; display: flex; flex-direction: column; gap: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .add-box h3 { margin: 0 0 10px 0; color: #555; }
        .add-box input, .add-box textarea { padding: 12px; border: 2px solid #eee; border-radius: 10px; font-size: 16px; outline: none; transition: 0.3s; }
        .add-box textarea { resize: vertical; min-height: 80px; font-family: inherit; }
        .add-box input:focus, .add-box textarea:focus { border-color: #764ba2; }
        .save-btn { background: #764ba2; color: white; border: none; padding: 12px; border-radius: 10px; font-size: 16px; cursor: pointer; transition: 0.3s; font-weight: bold; }
        .save-btn:hover { background: #5a387e; }
        .recipe-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .recipe-card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); transition: transform 0.3s; display: flex; flex-direction: column; justify-content: space-between; min-height: 200px; }
        .recipe-card:hover { transform: translateY(-5px); }
        .card-content { margin-bottom: 15px; }
        .recipe-title { font-size: 20px; font-weight: bold; color: #333; margin-bottom: 10px; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; }
        .recipe-desc { font-size: 15px; color: #666; line-height: 1.6; white-space: pre-wrap; }
        .card-actions { display: flex; gap: 10px; margin-top: auto; }
        .action-btn { flex: 1; padding: 8px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; transition: 0.2s; }
        .edit-btn { background-color: #f39c12; color: white; }
        .edit-btn:hover { background-color: #d35400; }
        .delete-btn { background-color: #e74c3c; color: white; }
        .delete-btn:hover { background-color: #c0392b; }
        .loading { text-align: center; color: white; font-size: 18px; margin-top: 50px; }
    </style>
</head>
<body>

<header>
    <h1> Recipe Manager</h1>
    <button class="logout-btn" onclick="logout()">Logout</button>
</header>

<div class="container">
    <div class="add-box">
        <h3 id="form-title">Add New Recipe</h3>
        <input type="hidden" id="recipe-id">
        <input type="text" id="recipe-title" placeholder="Recipe Name (e.g. Pasta)">
        <textarea id="recipe-desc" placeholder="Write the full recipe details here..." rows="4"></textarea>
        <button id="save-btn" class="save-btn" onclick="saveRecipe()">+ Add Recipe</button>
        <button id="cancel-btn" onclick="resetForm()" style="display:none; background:#ccc; border:none; padding:10px; border-radius:10px; cursor:pointer;">Cancel Edit</button>
    </div>

    <div id="recipe-grid" class="recipe-grid">
        <div class="loading">Loading recipes...</div>
    </div>
</div>

<script>
    window.onload = function() { fetchRecipes(); };

    async function fetchRecipes() {
        try {
            const response = await fetch("/recipes");
            if (response.status === 401) { window.location.href = "/"; return; }
            const recipes = await response.json();
            const grid = document.getElementById("recipe-grid");
            grid.innerHTML = "";
            if (recipes.length === 0) {
                grid.innerHTML = "<p style='color:white; text-align:center; width:100%;'>No recipes yet. Add one above!</p>";
                return;
            }
            recipes.forEach(recipe => {
                const card = document.createElement("div");
                card.className = "recipe-card";
                card.innerHTML = `
                    <div class="card-content">
                        <div class="recipe-title">${escapeHtml(recipe.title)}</div>
                        <div class="recipe-desc">${escapeHtml(recipe.description)}</div>
                    </div>
                    <div class="card-actions">
                        <button class="action-btn edit-btn" onclick="editRecipe(${recipe.id}, '${escapeHtml(recipe.title)}', '${escapeHtml(recipe.description.replace(/\n/g, '\\n').replace(/'/g, "\\'"))}')">Edit</button>
                        <button class="action-btn delete-btn" onclick="deleteRecipe(${recipe.id})">Delete</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        } catch (error) { console.error("Hata:", error); }
    }

    async function saveRecipe() {
        const id = document.getElementById("recipe-id").value;
        const title = document.getElementById("recipe-title").value;
        const description = document.getElementById("recipe-desc").value;

        if (!title || !description) return alert("Please fill both fields!");

        const method = id ? "PUT" : "POST";
        const url = id ? `/recipes/${id}` : "/recipes";

        try {
            const response = await fetch(url, {
                method: method,
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ title, description })
            });
            if (response.ok) {
                resetForm();
                fetchRecipes();
            } else {
                alert("Operation failed! Check backend logs.");
            }
        } catch (error) { console.error("Error:", error); }
    }

    async function deleteRecipe(id) {
        if (!confirm("Are you sure you want to delete this recipe?")) return;
        try {
            const response = await fetch(`/recipes/${id}`, { method: "DELETE" });
            if (response.ok) fetchRecipes();
            else alert("Could not delete recipe.");
        } catch (error) { console.error("Delete error:", error); }
    }

    function editRecipe(id, title, desc) {
        document.getElementById("recipe-id").value = id;
        document.getElementById("recipe-title").value = title;
        document.getElementById("recipe-desc").value = desc;
        document.getElementById("form-title").innerText = "Edit Recipe";
        document.getElementById("save-btn").innerText = "Update Recipe";
        document.getElementById("cancel-btn").style.display = "inline-block";
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function resetForm() {
        document.getElementById("recipe-id").value = "";
        document.getElementById("recipe-title").value = "";
        document.getElementById("recipe-desc").value = "";
        document.getElementById("form-title").innerText = "Add New Recipe";
        document.getElementById("save-btn").innerText = "+ Add Recipe";
        document.getElementById("cancel-btn").style.display = "none";
    }

    async function logout() {
        await fetch("/auth/logout", { method: "POST" });
        window.location.href = "/";
    }

    function escapeHtml(text) {
        if (!text) return "";
        return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }
</script>
</body>
</html>